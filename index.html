
<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>inhouse agenda</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Space+Grotesk:wght@400;500;700&display=swap');
:root{--bg:#f4f0e6;--card:#ffffffd9;--line:#18222f1a;--txt:#17202a;--muted:#5a6773;--blue:#0b7285;--coral:#e76f51;--gold:#f4a261;--ok:#2a9d8f;--danger:#c1121f}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Space Grotesk',sans-serif;color:var(--txt);background:radial-gradient(circle at 10% 5%,#fff7e6,transparent 38%),radial-gradient(circle at 90% 0%,#f9d7c8,transparent 32%),var(--bg)}
#app{height:100%;display:grid;grid-template-rows:auto auto 1fr;gap:10px;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 14px 30px #18222f14}
.top{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.mark{width:30px;height:30px;border-radius:10px;background:linear-gradient(140deg,var(--coral),var(--gold));box-shadow:0 8px 18px #e76f5140}
.title{font-family:'Syne',sans-serif;font-size:1.08rem;white-space:nowrap}
.sub{font-size:.78rem;color:var(--muted)}
.actions{display:flex;align-items:center;gap:7px;flex-wrap:wrap;justify-content:flex-end}
.pill{font-size:.74rem;color:var(--muted);padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;max-width:min(44vw,320px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
button,input,select{font:inherit}
.btn{border:1px solid transparent;border-radius:10px;padding:8px 10px;font-weight:700;font-size:.82rem;cursor:pointer}
.btn:disabled{opacity:.55;cursor:not-allowed}
.b1{background:linear-gradient(130deg,var(--blue),#0f6272);color:#fff}
.b2{background:#fff;color:var(--txt);border-color:var(--line)}
.bd{background:#fff;color:var(--danger);border-color:#c1121f33}
.tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;padding:7px}
.tab{border:none;border-radius:10px;padding:10px;font-weight:700;color:var(--muted);background:transparent;cursor:pointer}
.tab.on{background:linear-gradient(130deg,var(--coral),#d95f46);color:#fff}
main{position:relative;min-height:0}
.pane{position:absolute;inset:0;display:none;overflow:auto;padding:2px}
.pane.on{display:block}
.inner{padding:12px;min-height:100%}
.toolbar{display:flex;justify-content:space-between;flex-wrap:wrap;gap:9px;align-items:center}
.seg{display:inline-flex;gap:4px;border:1px solid var(--line);padding:4px;border-radius:11px;background:#fff}
.seg button{border:0;padding:7px 9px;border-radius:8px;font-size:.77rem;font-weight:700;background:transparent;color:var(--muted);cursor:pointer}
.seg button.on{background:var(--txt);color:#fff}
.nav{display:flex;gap:7px;flex-wrap:wrap}
.meta{display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap;margin:11px 0 9px}
.meta h2{font-family:'Syne',sans-serif;font-size:1.12rem}
.meta p{font-size:.78rem;color:var(--muted)}
#cal{border:1px solid var(--line);border-radius:12px;background:#fff;min-height:420px;overflow:hidden}
.empty{padding:34px 10px;text-align:center;color:var(--muted);font-size:.88rem}
.chip{display:block;margin:0 0 5px;padding:6px;border:1px solid #0b728533;background:#0b728518;color:#0e4450;border-radius:8px;text-decoration:none;font-size:.74rem;font-weight:700;line-height:1.25}
.month{display:grid;grid-template-columns:repeat(7,1fr)}
.mh{padding:8px;text-align:center;font-size:.74rem;font-weight:700;color:var(--muted);background:#18222f08;border-bottom:1px solid var(--line)}
.cell{min-height:112px;padding:7px;border-right:1px solid var(--line);border-bottom:1px solid var(--line)}
.cell:nth-child(7n){border-right:none}
.out{background:#18222f06}
.d{font-size:.74rem;color:var(--muted);font-weight:700;margin-bottom:5px}
.today .d{color:var(--coral)}
.week{display:grid;grid-template-columns:repeat(7,1fr)}
.wcol{padding:8px;border-right:1px solid var(--line);min-height:430px}
.wcol:last-child{border-right:none}
.wh{font-size:.77rem;color:var(--muted);font-weight:700;margin-bottom:7px}
.day{display:grid;gap:7px;padding:11px}
.row{border:1px solid var(--line);border-radius:11px;padding:10px;background:#fff;display:grid;gap:3px}
.time{font-size:.72rem;color:var(--muted);font-weight:700}
.rt{font-size:.87rem;font-weight:700}
.link{font-size:.72rem;color:var(--blue);text-decoration:none}
.year{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;padding:11px}
.ym{border:1px solid var(--line);border-radius:11px;padding:9px;background:#fff;cursor:pointer}
.ym h3{font-size:.84rem}.ym p{font-size:.73rem;color:var(--muted);margin:4px 0 7px}
.pg{display:grid;grid-template-columns:260px 1fr;gap:10px;min-height:calc(100vh - 220px)}
.box{border:1px solid var(--line);border-radius:12px;background:#fff;padding:11px;box-shadow:0 8px 20px #18222f12}
.box h3{font-family:'Syne',sans-serif;font-size:1rem;margin-bottom:8px}
.f1{display:flex;gap:7px;margin-bottom:8px}
.input{width:100%;border:1px solid var(--line);border-radius:9px;padding:8px 9px;background:#fff;font-size:.84rem}
.plist,.tlist,.slist{list-style:none;display:grid;gap:7px}
.plist{max-height:calc(100vh - 370px);overflow:auto;padding-right:3px}
.pitem{border:1px solid var(--line);border-radius:10px;background:#fff;padding:9px;display:grid;grid-template-columns:1fr auto;gap:7px;align-items:center}
.pitem.on{border-color:#0b728552;box-shadow:0 8px 16px #0b728521}
.pm{cursor:pointer;min-width:0}
.pn{display:flex;align-items:center;gap:7px;font-size:.85rem;font-weight:700}
.dot{width:10px;height:10px;border-radius:99px}
.ps{margin-top:3px;font-size:.72rem;color:var(--muted)}
.mini{border:1px solid var(--line);border-radius:8px;background:#fff;padding:5px 7px;font-size:.74rem;font-weight:700;cursor:pointer}
.mini.d{color:var(--danger);border-color:#c1121f33}
.tt{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.tm{font-size:.76rem;color:var(--muted)}
.f2{display:grid;grid-template-columns:1fr 125px 120px auto;gap:7px;margin-bottom:10px}
.tlist{max-height:calc(100vh - 390px);overflow:auto;padding-right:3px}
.ti{border:1px solid var(--line);border-radius:10px;background:#fff;padding:9px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.ti.done{opacity:.65}
.tb{display:grid;gap:3px}
.ttitle{display:flex;align-items:center;gap:7px;font-size:.85rem;font-weight:700;min-width:0}
.ttitle span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ti.done .ttitle span{text-decoration:line-through}
.ts{font-size:.72rem;color:var(--muted)}
.ta{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.prio{font-size:.64rem;font-weight:700;border-radius:999px;padding:2px 6px;text-transform:uppercase}
.p-low{background:#2646531a;color:#264653}.p-medium{background:#f4a2612f;color:#9a661b}.p-high{background:#e76f5130;color:#8f2d1b}.p-urgent{background:#c1121f2f;color:#7f0000}
.now{display:grid;grid-template-columns:repeat(3,1fr);gap:9px}
.nbox{border:1px solid var(--line);border-radius:12px;background:#fff;padding:11px;box-shadow:0 8px 18px #18222f12}
.nbox h3{font-family:'Syne',sans-serif;font-size:.96rem;margin-bottom:8px}
.span2{grid-column:span 2}
.metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:7px}
.m{border:1px solid var(--line);border-radius:10px;background:#fff;padding:9px}
.mn{font-family:'Syne',sans-serif;font-size:1.28rem;line-height:1}.ml{margin-top:4px;font-size:.71rem;color:var(--muted)}
.slist{max-height:265px;overflow:auto;padding-right:3px}
.si{border:1px solid var(--line);border-radius:9px;background:#fff;padding:8px;display:grid;gap:3px}
.si .st{font-size:.84rem;font-weight:700}.si .sm{font-size:.72rem;color:var(--muted)}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:10px;background:#17202a66;z-index:50}
.modal.on{display:flex}
.mc{width:min(480px,100%);background:#fff;border:1px solid var(--line);border-radius:15px;padding:14px;display:grid;gap:10px}
.mc h3{font-family:'Syne',sans-serif}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.field{display:grid;gap:4px}.field label{font-size:.73rem;color:var(--muted);font-weight:700}
.check{display:flex;align-items:center;gap:7px;color:var(--muted);font-size:.8rem}
.ma{display:flex;justify-content:flex-end;gap:8px}
#toast{position:fixed;left:50%;bottom:14px;transform:translate(-50%,14px);opacity:0;background:#1f2933;color:#fff;padding:9px 12px;border-radius:10px;font-size:.8rem;transition:.2s;z-index:70;max-width:min(90vw,520px);text-align:center}
#toast.on{opacity:1;transform:translate(-50%,0)}
.hide{display:none!important}
@media (max-width:1040px){.year{grid-template-columns:repeat(2,1fr)}.now{grid-template-columns:repeat(2,1fr)}}
@media (max-width:920px){#app{padding:9px}.pg{grid-template-columns:1fr}.plist,.tlist{max-height:none}.f2{grid-template-columns:1fr}}
@media (max-width:760px){.sub,.pill{display:none}.month{grid-template-columns:1fr}.mh{display:none}.cell{border-right:none;min-height:90px}.week{grid-template-columns:1fr}.wcol{border-right:none;border-bottom:1px solid var(--line);min-height:auto}.year,.now,.metrics,.grid2{grid-template-columns:1fr}.span2{grid-column:span 1}}
</style>
</head>
<body>
<div id="app">
<header class="top card">
<div class="brand"><div class="mark"></div><div><div class="title">inhouse agenda</div><div class="sub">Calendar + Projects + Now View</div></div></div>
<div class="actions">
<span class="pill" id="authPill">Google Calendar not connected</span>
<button class="btn b2" id="signIn">Connect Google</button>
<button class="btn bd hide" id="signOut">Sign out</button>
<button class="btn b2" id="syncBtn" disabled>Sync</button>
<button class="btn b1" id="newEvent" disabled>New Event</button>
</div>
</header>
<nav class="tabs card">
<button class="tab on" data-tab="calendar">Calendar</button>
<button class="tab" data-tab="projects">Projects</button>
<button class="tab" data-tab="now">Now View</button>
</nav>
<main>
<section class="pane on" id="pane-calendar"><div class="inner card">
<div class="toolbar">
<div class="seg" id="viewSeg">
<button data-view="day">Day</button><button data-view="week">Week</button><button data-view="month" class="on">Month</button><button data-view="year">Year</button>
</div>
<div class="nav"><button class="btn b2" id="prev">Prev</button><button class="btn b2" id="today">Today</button><button class="btn b2" id="next">Next</button></div>
</div>
<div class="meta"><h2 id="rangeLabel">Month</h2><p id="syncLabel">Not synced yet.</p></div>
<div id="cal"></div>
</div></section>
<section class="pane" id="pane-projects"><div class="inner card"><div class="pg">
<aside class="box"><h3>Projects</h3>
<form class="f1" id="projectForm"><input class="input" id="projectName" placeholder="New project name" maxlength="80" required><button class="btn b1" type="submit">Add</button></form>
<ul class="plist" id="projectList"></ul></aside>
<section class="box"><div class="tt"><h3 id="taskTitleHead">Tasks</h3><p class="tm" id="taskMeta">0 open tasks</p></div>
<form class="f2" id="taskForm">
<input class="input" id="taskName" placeholder="Task title" maxlength="140" required>
<input class="input" id="taskDue" type="date">
<select class="input" id="taskPriority"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="urgent">Urgent</option></select>
<button class="btn b1" type="submit">Add Task</button>
</form>
<ul class="tlist" id="taskList"></ul></section>
</div></div></section>
<section class="pane" id="pane-now"><div class="inner card"><div class="now">
<article class="nbox span2"><h3>Focus Metrics</h3><div class="metrics" id="nowMetrics"></div></article>
<article class="nbox"><h3>Next 24 Hours</h3><ul class="slist" id="nowEvents"></ul></article>
<article class="nbox"><h3>Task Radar</h3><ul class="slist" id="nowRadar"></ul></article>
<article class="nbox span2"><h3>Priority Focus</h3><ul class="slist" id="nowFocus"></ul></article>
</div></div></section>
</main>
</div>

<div class="modal" id="modal">
<div class="mc">
<h3>Create Calendar Event</h3>
<form id="eventForm">
<div class="field"><label for="evTitle">Title</label><input class="input" id="evTitle" required maxlength="120"></div>
<div class="check"><input id="evAll" type="checkbox"><label for="evAll">All day</label></div>
<div class="grid2">
<div class="field"><label for="evStartDate">Start date</label><input class="input" id="evStartDate" type="date" required></div>
<div class="field"><label for="evEndDate">End date</label><input class="input" id="evEndDate" type="date" required></div>
<div class="field" id="startTimeWrap"><label for="evStartTime">Start time</label><input class="input" id="evStartTime" type="time" value="09:00"></div>
<div class="field" id="endTimeWrap"><label for="evEndTime">End time</label><input class="input" id="evEndTime" type="time" value="09:30"></div>
</div>
<div class="ma"><button class="btn b2" type="button" id="closeModal">Cancel</button><button class="btn b1" type="submit">Create</button></div>
</form>
</div>
</div>
<div id="toast"></div>

<script>
const CLIENT_ID='435784295430-cmug30o42f1vu4ijgor9sjb0ro4oo37o.apps.googleusercontent.com';
const SCOPE=['https://www.googleapis.com/auth/calendar','https://www.googleapis.com/auth/userinfo.email','https://www.googleapis.com/auth/userinfo.profile'].join(' ');
const K={p:'inhouse-agenda-projects-v1',u:'inhouse-agenda-ui-v1',g:'inhouse-agenda-google-v1'};
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const COLORS=['#0b7285','#2a9d8f','#e76f51','#f4a261','#264653','#3a5a40'];
const W={low:1,medium:2,high:3,urgent:4};
const st={tab:'calendar',view:'month',cursor:sod(new Date()),events:[],rangeKey:'',lastSync:0,projects:[],sel:null,google:{client:null,ready:false,token:null,exp:0,profile:null}};
let toastT=0,tokenP=null;

const el={
auth:$('authPill'),signIn:$('signIn'),signOut:$('signOut'),sync:$('syncBtn'),newEvent:$('newEvent'),
tabs:[...document.querySelectorAll('.tab')],panes:[...document.querySelectorAll('.pane')],
views:[...document.querySelectorAll('#viewSeg button')],range:$('rangeLabel'),syncLabel:$('syncLabel'),cal:$('cal'),
prev:$('prev'),next:$('next'),today:$('today'),
projectForm:$('projectForm'),projectName:$('projectName'),projectList:$('projectList'),
taskForm:$('taskForm'),taskName:$('taskName'),taskDue:$('taskDue'),taskPriority:$('taskPriority'),taskList:$('taskList'),taskHead:$('taskTitleHead'),taskMeta:$('taskMeta'),
nowMetrics:$('nowMetrics'),nowEvents:$('nowEvents'),nowRadar:$('nowRadar'),nowFocus:$('nowFocus'),
modal:$('modal'),eventForm:$('eventForm'),evTitle:$('evTitle'),evAll:$('evAll'),evStartDate:$('evStartDate'),evEndDate:$('evEndDate'),evStartTime:$('evStartTime'),evEndTime:$('evEndTime'),startTimeWrap:$('startTimeWrap'),endTimeWrap:$('endTimeWrap'),closeModal:$('closeModal'),
toast:$('toast')
};

function $(id){return document.getElementById(id)}
function uid(p='id'){return `${p}-${Math.random().toString(36).slice(2,9)}-${Date.now().toString(36)}`}
function sod(d){d=new Date(d);d.setHours(0,0,0,0);return d}
function add(d,n){d=new Date(d);d.setDate(d.getDate()+n);return d}
function sow(d){d=sod(d);return add(d,-d.getDay())}
function som(d){return new Date(d.getFullYear(),d.getMonth(),1)}
function eom(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}
function dstr(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`}
function pdate(s){if(!s)return null;const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d)}
function fmt(d,o){return new Intl.DateTimeFormat(undefined,o).format(d)}
function esc(v){return String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function rel(ts){if(!ts)return'Not synced yet.';const m=Math.floor((Date.now()-ts)/60000);if(m<1)return'Synced just now.';if(m<60)return`Synced ${m}m ago.`;return`Synced ${fmt(new Date(ts),{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}.`}
function toast(t){el.toast.textContent=t;el.toast.classList.add('on');clearTimeout(toastT);toastT=setTimeout(()=>el.toast.classList.remove('on'),2800)}
function saveProjects(){localStorage.setItem(K.p,JSON.stringify(st.projects))}
function saveUI(){localStorage.setItem(K.u,JSON.stringify({tab:st.tab,view:st.view,cursor:st.cursor.toISOString(),sel:st.sel}))}
function saveGoogle(){if(!st.google.token||st.google.exp<=Date.now()){localStorage.removeItem(K.g);return}localStorage.setItem(K.g,JSON.stringify({token:st.google.token,exp:st.google.exp,profile:st.google.profile||null}))}

function load(){
try{const r=JSON.parse(localStorage.getItem(K.p)||'[]');if(Array.isArray(r))st.projects=r.filter(p=>p&&typeof p.name==='string').map(p=>({id:p.id||uid('p'),name:p.name.trim()||'Untitled',color:p.color||COLORS[Math.floor(Math.random()*COLORS.length)],tasks:Array.isArray(p.tasks)?p.tasks.map(t=>({id:t.id||uid('t'),title:(t.title||'').trim()||'Untitled',done:!!t.done,dueDate:t.dueDate||'',priority:W[t.priority]?t.priority:'medium',synced:t.synced||null})):[]}))}
catch(e){console.error(e)}
try{const u=JSON.parse(localStorage.getItem(K.u)||'{}');if(['calendar','projects','now'].includes(u.tab))st.tab=u.tab;if(['day','week','month','year'].includes(u.view))st.view=u.view;if(u.cursor){const d=new Date(u.cursor);if(!Number.isNaN(+d))st.cursor=sod(d)}if(u.sel)st.sel=u.sel}catch(e){console.error(e)}
try{const g=JSON.parse(localStorage.getItem(K.g)||'{}');if(g.token&&g.exp>Date.now()){st.google.token=g.token;st.google.exp=g.exp;st.google.profile=g.profile||null}}catch(e){console.error(e)}
if(!st.projects.some(p=>p.id===st.sel))st.sel=st.projects[0]?.id||null;
}

function connected(){return !!(st.google.token&&st.google.exp>Date.now()+30000)}
function authUI(){const c=connected();el.signIn.classList.toggle('hide',c);el.signOut.classList.toggle('hide',!c);el.sync.disabled=!c;el.newEvent.disabled=!c;el.auth.textContent=c?(st.google.profile?.email||'Google connected'):'Google Calendar not connected'}

function initGoogle(){
const tick=()=>{if(!window.google?.accounts?.oauth2){setTimeout(tick,220);return}
st.google.client=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPE,callback:()=>{}});
st.google.ready=true;authUI();if(connected()){void loadProfile();void sync(true)}};
tick();
}

function reqToken(interactive){
if(!st.google.ready||!st.google.client)return Promise.reject(new Error('Google auth not ready'));
return new Promise((res,rej)=>{
st.google.client.callback=r=>{if(r.error){rej(new Error(r.error_description||r.error));return}st.google.token=r.access_token;st.google.exp=Date.now()+(r.expires_in||3600)*1000;saveGoogle();authUI();res(st.google.token)};
st.google.client.error_callback=e=>rej(e instanceof Error?e:new Error('Google auth error'));
st.google.client.requestAccessToken({prompt:interactive?'consent':''});
});
}

async function ensureToken(interactive=false){if(connected())return st.google.token;if(tokenP)return tokenP;tokenP=reqToken(interactive).finally(()=>tokenP=null);return tokenP}

async function api(url,opt={},retry=true){
const t=await ensureToken(false);const h=new Headers(opt.headers||{});h.set('Authorization',`Bearer ${t}`);
const r=await fetch(url,{...opt,headers:h});
if(r.status===401&&retry){st.google.token=null;st.google.exp=0;saveGoogle();return api(url,opt,false)}
if(!r.ok){const tx=await r.text().catch(()=> '');throw new Error(tx||`Google request failed (${r.status})`)}
return r;
}

async function loadProfile(){if(!connected())return;try{const r=await api('https://www.googleapis.com/oauth2/v2/userinfo');const d=await r.json();st.google.profile={email:d.email||'',name:d.name||''};saveGoogle();authUI()}catch(e){console.error(e)}}
function normEvent(e){const all=!!e?.start?.date,start=all?e.start?.date:e.start?.dateTime,end=all?e.end?.date:e.end?.dateTime;if(!start||!end)return null;return{id:e.id||uid('ev'),title:e.summary?.trim()||'(Untitled)',all,start,end,link:e.htmlLink||''}}
function estart(e){return e.all?pdate(e.start):new Date(e.start)}
function eend(e){return e.all?pdate(e.end):new Date(e.end)}
function overlap(e,a,b){const s=estart(e),en=eend(e);return s&&en&&s<b&&en>a}
function inRange(a,b){return st.events.filter(e=>overlap(e,a,b)).sort((x,y)=>estart(x)-estart(y))}
function syncWindow(){const y=st.cursor.getFullYear(),s=new Date(y-1,11,1),e=new Date(y+1,1,1);return{start:s,end:e,key:`${dstr(s)}|${dstr(e)}`}}

async function fetchEvents(start,end){
const out=[];let token='';
while(true){
const q=new URLSearchParams({singleEvents:'true',orderBy:'startTime',timeMin:start.toISOString(),timeMax:end.toISOString(),maxResults:'2500'});
if(token)q.set('pageToken',token);
const r=await api(`https://www.googleapis.com/calendar/v3/calendars/primary/events?${q}`),d=await r.json();
out.push(...(d.items||[]).map(normEvent).filter(Boolean));if(!d.nextPageToken)break;token=d.nextPageToken;
}
return out;
}

async function sync(force=false){
if(!connected())return;const w=syncWindow();if(!force&&st.rangeKey===w.key)return;
el.syncLabel.textContent='Syncing with Google Calendar...';
try{st.events=await fetchEvents(w.start,w.end);st.rangeKey=w.key;st.lastSync=Date.now();el.syncLabel.textContent=rel(st.lastSync);renderCal();renderNow();toast(`Synced ${st.events.length} events`)}
catch(e){console.error(e);el.syncLabel.textContent='Sync failed. Check Google setup.';toast('Calendar sync failed')}
}

function calRange(){
if(st.view==='day'){const s=sod(st.cursor),e=add(s,1);return{start:s,end:e,label:fmt(s,{weekday:'long',month:'long',day:'numeric',year:'numeric'})}}
if(st.view==='week'){const s=sow(st.cursor),e=add(s,7),ee=add(e,-1);return{start:s,end:e,label:`${fmt(s,{month:'short',day:'numeric'})} - ${fmt(ee,{month:'short',day:'numeric',year:'numeric'})}`}}
if(st.view==='month'){const f=som(st.cursor),g=sow(f),e=add(g,42);return{start:g,end:e,mstart:f,label:fmt(f,{month:'long',year:'numeric'})}}
const y=st.cursor.getFullYear();return{start:new Date(y,0,1),end:new Date(y+1,0,1),label:String(y)}
}

function etime(e){if(e.all)return'All day';const s=estart(e),en=eend(e);return`${fmt(s,{hour:'numeric',minute:'2-digit'})} - ${fmt(en,{hour:'numeric',minute:'2-digit'})}`}
function chip(e){const a=document.createElement(e.link?'a':'div');a.className='chip';a.textContent=`${e.all?'All day':fmt(estart(e),{hour:'numeric',minute:'2-digit'})} - ${e.title}`;if(e.link){a.href=e.link;a.target='_blank';a.rel='noreferrer noopener'}return a}

function renderDay(r){
const ev=inRange(r.start,r.end);if(!ev.length){el.cal.innerHTML='<div class="empty">No events in this day.</div>';return}
const w=document.createElement('div');w.className='day';
ev.forEach(e=>{const row=document.createElement('article');row.className='row';row.innerHTML=`<div class="time">${etime(e)}</div><div class="rt">${esc(e.title)}</div>`;if(e.link){const a=document.createElement('a');a.className='link';a.href=e.link;a.target='_blank';a.rel='noreferrer noopener';a.textContent='Open in Google Calendar';row.appendChild(a)}w.appendChild(row)});
el.cal.innerHTML='';el.cal.appendChild(w);
}

function renderWeek(r){
const g=document.createElement('div');g.className='week';
for(let i=0;i<7;i++){const d=add(r.start,i),a=sod(d),b=add(a,1),ev=inRange(a,b),c=document.createElement('div');c.className='wcol';c.innerHTML=`<div class="wh">${DAYS[d.getDay()]} ${d.getDate()}</div>`;if(!ev.length){const p=document.createElement('p');p.className='tm';p.textContent='No events';c.appendChild(p)}else ev.forEach(e=>c.appendChild(chip(e)));g.appendChild(c)}
el.cal.innerHTML='';el.cal.appendChild(g);
}

function renderMonth(r){
const g=document.createElement('div');g.className='month';DAYS.forEach(x=>{const h=document.createElement('div');h.className='mh';h.textContent=x;g.appendChild(h)});
for(let i=0;i<42;i++){const d=add(r.start,i),a=sod(d),b=add(a,1),ev=inRange(a,b),c=document.createElement('div');const out=d.getMonth()!==r.mstart.getMonth(),today=dstr(d)===dstr(new Date());c.className=`cell${out?' out':''}${today?' today':''}`;c.innerHTML=`<div class="d">${DAYS[d.getDay()]} ${d.getDate()}</div>`;ev.slice(0,3).forEach(e=>c.appendChild(chip(e)));if(ev.length>3){const p=document.createElement('p');p.className='tm';p.textContent=`+${ev.length-3} more`;c.appendChild(p)};c.onclick=()=>{st.cursor=sod(d);saveUI();renderCal()};g.appendChild(c)}
el.cal.innerHTML='';el.cal.appendChild(g);
}

function renderYear(r){
const y=r.start.getFullYear(),w=document.createElement('div');w.className='year';
for(let m=0;m<12;m++){const a=new Date(y,m,1),b=new Date(y,m+1,1),ev=inRange(a,b),c=document.createElement('div');c.className='ym';c.innerHTML=`<h3>${MONTHS[m]}</h3><p>${ev.length} event${ev.length===1?'':'s'}</p>`;if(!ev.length){const p=document.createElement('p');p.className='tm';p.textContent='No events';c.appendChild(p)}else{ev.slice(0,4).forEach(e=>c.appendChild(chip(e)));if(ev.length>4){const p=document.createElement('p');p.className='tm';p.textContent=`+${ev.length-4} more`;c.appendChild(p)}}c.onclick=()=>{st.cursor=new Date(y,m,1);setView('month')};w.appendChild(c)}
el.cal.innerHTML='';el.cal.appendChild(w);
}
function renderCal(){
const r=calRange();el.range.textContent=r.label;el.syncLabel.textContent=rel(st.lastSync);
if(!connected()){el.cal.innerHTML='<div class="empty">Connect Google Calendar to load events.</div>';return}
if(st.view==='day')return renderDay(r);if(st.view==='week')return renderWeek(r);if(st.view==='month')return renderMonth(r);renderYear(r);
}

function setView(v){if(!['day','week','month','year'].includes(v))return;st.view=v;el.views.forEach(b=>b.classList.toggle('on',b.dataset.view===v));saveUI();renderCal()}
function move(step){const d=new Date(st.cursor);if(st.view==='day')d.setDate(d.getDate()+step);else if(st.view==='week')d.setDate(d.getDate()+step*7);else if(st.view==='month')d.setMonth(d.getMonth()+step);else d.setFullYear(d.getFullYear()+step);st.cursor=sod(d);saveUI();renderCal();void sync(false)}

function selProject(){return st.projects.find(p=>p.id===st.sel)||null}
function ensureSel(){if(!st.projects.some(p=>p.id===st.sel))st.sel=st.projects[0]?.id||null}

function addProject(name){
name=name.trim();if(!name)return;
const p={id:uid('p'),name,color:COLORS[st.projects.length%COLORS.length],tasks:[]};
st.projects.unshift(p);st.sel=p.id;saveProjects();saveUI();renderProjects();renderNow();
}
function delProject(id){const p=st.projects.find(x=>x.id===id);if(!p)return;if(!confirm(`Delete project "${p.name}" and all its tasks?`))return;st.projects=st.projects.filter(x=>x.id!==id);ensureSel();saveProjects();saveUI();renderProjects();renderNow()}
function addTask({title,dueDate,priority}){const p=selProject();if(!p)return;title=title.trim();if(!title)return;p.tasks.unshift({id:uid('t'),title,done:false,dueDate:dueDate||'',priority:W[priority]?priority:'medium',synced:null});saveProjects();renderProjects();renderNow()}
function togTask(pid,tid){const p=st.projects.find(x=>x.id===pid),t=p?.tasks.find(x=>x.id===tid);if(!t)return;t.done=!t.done;saveProjects();renderProjects();renderNow()}
function delTask(pid,tid){const p=st.projects.find(x=>x.id===pid);if(!p)return;p.tasks=p.tasks.filter(x=>x.id!==tid);saveProjects();renderProjects();renderNow()}
async function taskToCal(pid,tid){
const p=st.projects.find(x=>x.id===pid),t=p?.tasks.find(x=>x.id===tid);if(!t)return;if(!connected())return toast('Connect Google Calendar first.');
const d=t.dueDate?pdate(t.dueDate):sod(new Date()),s=new Date(d),e=new Date(d);s.setHours(9,0,0,0);e.setHours(9,30,0,0);
const body={summary:`[${p.name}] ${t.title}`,description:'Created from inhouse agenda task.',start:{dateTime:s.toISOString()},end:{dateTime:e.toISOString()}};
try{await api('https://www.googleapis.com/calendar/v3/calendars/primary/events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});t.synced='ok';saveProjects();renderProjects();toast('Task sent to Google Calendar');void sync(true)}catch(err){console.error(err);toast('Could not create event')}
}

function renderProjects(){
ensureSel();el.projectList.innerHTML='';
if(!st.projects.length){el.projectList.innerHTML='<li class="empty">No projects yet.</li>';el.taskHead.textContent='Tasks';el.taskMeta.textContent='Create a project to start.';el.taskList.innerHTML='<li class="empty">No project selected.</li>';return}
st.projects.forEach(p=>{const open=p.tasks.filter(t=>!t.done).length,it=document.createElement('li');it.className=`pitem${p.id===st.sel?' on':''}`;it.innerHTML=`<div class="pm" data-a="sel" data-p="${p.id}"><div class="pn"><span class="dot" style="background:${p.color}"></span><span>${esc(p.name)}</span></div><div class="ps">${open} open / ${p.tasks.length} total</div></div><button class="mini d" data-a="del" data-p="${p.id}">Delete</button>`;el.projectList.appendChild(it)});
const p=selProject();if(!p)return;const open=p.tasks.filter(t=>!t.done).length;el.taskHead.textContent=p.name;el.taskMeta.textContent=`${open} open tasks`;renderTaskList(p);
}

function renderTaskList(p){
el.taskList.innerHTML='';if(!p.tasks.length){el.taskList.innerHTML='<li class="empty">No tasks in this project.</li>';return}
p.tasks.forEach(t=>{const it=document.createElement('li');it.className=`ti${t.done?' done':''}`;it.innerHTML=`<div class="tb"><div class="ttitle"><input type="checkbox" data-a="tog" data-p="${p.id}" data-t="${t.id}" ${t.done?'checked':''}><span>${esc(t.title)}</span><span class="prio p-${t.priority}">${t.priority}</span></div><div class="ts">${t.dueDate?`Due ${t.dueDate}`:'No due date'}</div></div><div class="ta"><button class="mini" data-a="cal" data-p="${p.id}" data-t="${t.id}">${t.synced?'Resync':'To Calendar'}</button><button class="mini d" data-a="dt" data-p="${p.id}" data-t="${t.id}">Delete</button></div>`;el.taskList.appendChild(it)})
}

function allTasks(){const out=[];st.projects.forEach(p=>p.tasks.forEach(t=>out.push({...t,pid:p.id,pname:p.name,pcolor:p.color})));return out}
function mkItem(t,m){const li=document.createElement('li');li.className='si';li.innerHTML=`<div class="st">${esc(t)}</div><div class="sm">${esc(m)}</div>`;return li}
function fillList(node,items,empty){node.innerHTML='';if(!items.length){node.innerHTML=`<li class="empty">${esc(empty)}</li>`;return}items.forEach(i=>node.appendChild(i))}

function renderNow(){
const now=new Date(),d1=new Date(now.getTime()+86400000),d7=new Date(now.getTime()+7*86400000),today=sod(now);
const ev24=inRange(now,d1).slice(0,8),evWeek=inRange(now,d7),tasks=allTasks(),pending=tasks.filter(t=>!t.done),over=pending.filter(t=>t.dueDate&&pdate(t.dueDate)<today),soon=pending.filter(t=>t.dueDate&&pdate(t.dueDate)>=today&&pdate(t.dueDate)<=add(today,3));
const focus=pending.slice().sort((a,b)=>{const p=W[b.priority]-W[a.priority];if(p!==0)return p;if(!a.dueDate&&!b.dueDate)return 0;if(!a.dueDate)return 1;if(!b.dueDate)return-1;return pdate(a.dueDate)-pdate(b.dueDate)}).slice(0,7);
el.nowMetrics.innerHTML=`<div class="m"><div class="mn">${ev24.length}</div><div class="ml">Next 24h events</div></div><div class="m"><div class="mn">${over.length}</div><div class="ml">Overdue tasks</div></div><div class="m"><div class="mn">${soon.length}</div><div class="ml">Due in 3 days</div></div>`;
fillList(el.nowEvents,ev24.map(e=>mkItem(e.title,`${etime(e)}${e.all?'':`  ${fmt(estart(e),{month:'short',day:'numeric'})}`}`)),connected()?'No events in the next 24 hours.':'Connect Google to load events.');
const radar=[];over.slice(0,4).forEach(t=>radar.push(mkItem(t.title,`Overdue  ${t.pname}`)));soon.slice(0,4).forEach(t=>radar.push(mkItem(t.title,`Due ${t.dueDate}  ${t.pname}`)));fillList(el.nowRadar,radar,'No urgent tasks right now.');
const f=focus.map(t=>mkItem(t.title,`${t.pname}  ${t.dueDate?`Due ${t.dueDate}`:'No due date'}  ${t.priority}`));if(!f.length&&evWeek.length)evWeek.slice(0,6).forEach(e=>f.push(mkItem(e.title,`Calendar  ${fmt(estart(e),{month:'short',day:'numeric',hour:e.all?undefined:'numeric',minute:e.all?undefined:'2-digit'})}`)));fillList(el.nowFocus,f,'No immediate focus items.');
}

function switchTab(t){st.tab=t;el.tabs.forEach(b=>b.classList.toggle('on',b.dataset.tab===t));el.panes.forEach(p=>p.classList.toggle('on',p.id===`pane-${t}`));saveUI();if(t==='now')renderNow();if(t==='projects')renderProjects();if(t==='calendar')renderCal()}
function modalUI(show){el.modal.classList.toggle('on',show)}
function allDayUI(){const x=el.evAll.checked;el.startTimeWrap.classList.toggle('hide',x);el.endTimeWrap.classList.toggle('hide',x);el.evStartTime.disabled=x;el.evEndTime.disabled=x}

async function createEvent(ev){
ev.preventDefault();if(!connected())return toast('Connect Google Calendar first.');
const title=el.evTitle.value.trim(),sd=el.evStartDate.value,ed=el.evEndDate.value;if(!title||!sd||!ed)return toast('Fill all required fields.');
const all=el.evAll.checked,body={summary:title};
if(all){let safe=ed;if(safe<sd)safe=sd;body.start={date:sd};body.end={date:dstr(add(pdate(safe),1))}}
else{const stt=el.evStartTime.value||'09:00',ett=el.evEndTime.value||'09:30',s=new Date(`${sd}T${stt}:00`);let e=new Date(`${ed}T${ett}:00`);if(!(e>s))e=new Date(s.getTime()+1800000);body.start={dateTime:s.toISOString()};body.end={dateTime:e.toISOString()}}
try{await api('https://www.googleapis.com/calendar/v3/calendars/primary/events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});modalUI(false);toast('Event created');await sync(true)}catch(err){console.error(err);toast('Could not create event')}
}
function bind(){
el.tabs.forEach(b=>b.onclick=()=>switchTab(b.dataset.tab));
el.views.forEach(b=>b.onclick=()=>setView(b.dataset.view));
el.prev.onclick=()=>move(-1);el.next.onclick=()=>move(1);el.today.onclick=()=>{st.cursor=sod(new Date());saveUI();renderCal();void sync(false)};
el.signIn.onclick=async()=>{try{await ensureToken(true);await loadProfile();authUI();toast('Google connected');await sync(true)}catch(e){console.error(e);toast('Google sign-in failed')}};
el.signOut.onclick=()=>{if(st.google.token&&window.google?.accounts?.oauth2?.revoke)google.accounts.oauth2.revoke(st.google.token,()=>{});st.google.token=null;st.google.exp=0;st.google.profile=null;st.events=[];st.rangeKey='';st.lastSync=0;saveGoogle();authUI();renderCal();renderNow();toast('Signed out')};
el.sync.onclick=()=>void sync(true);
el.newEvent.onclick=()=>{if(!connected())return toast('Connect Google Calendar first.');const d=st.cursor||new Date();el.evTitle.value='';el.evAll.checked=false;el.evStartDate.value=dstr(d);el.evEndDate.value=dstr(d);el.evStartTime.value='09:00';el.evEndTime.value='09:30';allDayUI();modalUI(true);requestAnimationFrame(()=>el.evTitle.focus())};
el.closeModal.onclick=()=>modalUI(false);el.modal.onclick=e=>{if(e.target===el.modal)modalUI(false)};el.evAll.onchange=allDayUI;el.eventForm.onsubmit=createEvent;
el.projectForm.onsubmit=e=>{e.preventDefault();addProject(el.projectName.value);el.projectName.value='';el.projectName.focus()};
el.projectList.onclick=e=>{const t=e.target.closest('[data-a]');if(!t)return;const a=t.dataset.a,p=t.dataset.p;if(!p)return;if(a==='sel'){st.sel=p;saveUI();renderProjects()}else if(a==='del')delProject(p)};
el.taskForm.onsubmit=e=>{e.preventDefault();addTask({title:el.taskName.value,dueDate:el.taskDue.value,priority:el.taskPriority.value});el.taskName.value='';el.taskDue.value='';el.taskPriority.value='medium';el.taskName.focus()};
el.taskList.onclick=e=>{const t=e.target.closest('[data-a]');if(!t)return;const a=t.dataset.a,p=t.dataset.p,tid=t.dataset.t;if(!p||!tid)return;if(a==='tog')togTask(p,tid);else if(a==='dt')delTask(p,tid);else if(a==='cal')void taskToCal(p,tid)};
window.onkeydown=e=>{if(e.key==='Escape')modalUI(false)};
}

function init(){load();bind();authUI();setView(st.view);switchTab(st.tab);renderProjects();renderNow();renderCal();initGoogle()}
init();
</script>
</body>
</html>
